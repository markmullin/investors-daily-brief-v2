@echo off
echo 🚀 Starting Enhanced Market Dashboard with AI Fixes
echo =====================================================
echo.

REM Check if we're in the right directory
if not exist "backend" (
    echo ❌ Error: Please run this script from the root directory (investors-daily-brief)
    echo Current directory: %CD%
    echo Expected structure: investors-daily-brief\backend and investors-daily-brief\frontend
    pause
    exit /b 1
)

echo 📁 Current directory: %CD%
echo.

REM Install dependencies if needed
echo 🔧 Checking backend dependencies...
cd backend
if not exist "node_modules" (
    echo 📦 Installing backend dependencies...
    npm install
    if errorlevel 1 (
        echo ❌ Backend dependency installation failed
        pause
        exit /b 1
    )
) else (
    echo ✅ Backend dependencies already installed
)

REM Start backend server
echo.
echo 🌐 Starting backend server with enhanced AI routes...
echo    - Enhanced AI Analysis endpoints
echo    - Real current events from Bloomberg/CNBC/Barrons
echo    - TypewriterText for Sector and Macro analysis
echo.

start "Market Dashboard Backend" cmd /k "echo 🤖 Backend Server Starting... && node server.js"

REM Wait a moment for backend to start
echo ⏳ Waiting for backend to initialize...
timeout /t 5 /nobreak >nul

REM Start frontend
echo.
echo 🎨 Starting frontend...
cd ..\frontend

if not exist "node_modules" (
    echo 📦 Installing frontend dependencies...
    npm install
    if errorlevel 1 (
        echo ❌ Frontend dependency installation failed
        pause
        exit /b 1
    )
) else (
    echo ✅ Frontend dependencies already installed
)

echo.
echo 🖥️ Opening frontend development server...
start "Market Dashboard Frontend" cmd /k "echo 🎨 Frontend Server Starting... && npm run dev"

REM Wait and open browser
echo.
echo ⏳ Waiting for servers to fully start...
timeout /t 8 /nobreak >nul

echo.
echo 🌐 Opening Market Dashboard in browser...
start http://localhost:5173

echo.
echo ✅ STARTUP COMPLETE!
echo ===================
echo.
echo 🖥️ Frontend: http://localhost:5173
echo 🌐 Backend:  http://localhost:5000
echo.
echo 🎯 WHAT TO TEST:
echo ✓ Daily Market Brief - Should show real current events with TypewriterText
echo ✓ Sector Analysis - Should show AI analysis with TypewriterText effect
echo ✓ Macro Analysis - Should show AI analysis with TypewriterText effect  
echo ✓ Key Relationships - Should continue working as before
echo.
echo 📊 Check the console logs in both terminal windows for detailed information
echo 🔍 Look for "Enhanced Analysis" or "AI Generated" badges in the UI
echo.
echo Press any key to run backend tests...
pause >nul

REM Run backend tests
echo.
echo 🧪 Running Enhanced AI Tests...
cd ..\backend
node test-enhanced-ai-fixes.js

echo.
echo 🎉 All done! Your Market Dashboard is now running with enhanced AI analysis.
echo Press any key to exit...
pause >nul