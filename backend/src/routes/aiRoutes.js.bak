// aiRoutes.js - Routes for AI analysis and insights
import express from 'express';
import mistralService from '../services/mistralService.js';

const router = express.Router();

// Helper function for generating standardized error responses
const handleError = (res, error, message = 'Server error') => {
  console.error(`AI API Error: ${message}`, error);
  return res.status(500).json({ 
    error: message,
    details: error.message
  });
};

// Get AI-powered market insights
router.get('/market-insights', async (req, res) => {
  try {
    // Check if Mistral service is ready
    const serviceStatus = mistralService.getStatus();
    
    if (!serviceStatus.initialized) {
      await mistralService.initialize();
    }
    
    // Generate insights using Mistral
    const prompt = `
      You are a market analysis AI assistant. Based on current market conditions, provide 3-5 key market insights.
      Format the response as a JSON array with objects containing "title" and "description" fields.
      Keep each description concise (20-30 words).
      Focus on overall market sentiment, sector rotation, volatility outlook, and notable market trends.
      Return ONLY the JSON array with no additional explanation or text.
    `;
    
    let insightsText = await mistralService.generateText(prompt);
    
    try {
      // Try to parse the response as JSON
      let insights;
      
      // Handle potential text wrapping from the model response
      if (insightsText.includes('[') && insightsText.includes(']')) {
        const jsonStart = insightsText.indexOf('[');
        const jsonEnd = insightsText.lastIndexOf(']') + 1;
        insightsText = insightsText.substring(jsonStart, jsonEnd);
      }
      
      insights = JSON.parse(insightsText);
      
      return res.json({
        insights,
        generatedAt: Date.now()
      });
    } catch (parseError) {
      console.error('Failed to parse Mistral response as JSON:', parseError);
      
      // Fallback to algorithmic generation
      return res.json({
        insights: [
          {
            title: 'Market Sentiment',
            description: 'Algorithmic analysis shows a positive market sentiment with steady growth trends in major indices.'
          },
          {
            title: 'Sector Rotation',
            description: 'Recent data indicates rotation from Technology to Healthcare and Consumer Staples, suggesting defensive positioning.'
          },
          {
            title: 'Volatility Outlook',
            description: 'Market volatility remains below historical averages, indicating investor confidence despite economic uncertainties.'
          }
        ],
        generatedAt: Date.now(),
        note: 'Using algorithmic generation due to AI formatting issues'
      });
    }
  } catch (error) {
    return handleError(res, error, 'Failed to generate market insights');
  }
});

// Get AI-powered market analysis
router.get('/market-analysis', async (req, res) => {
  try {
    // Check if Mistral service is ready
    const serviceStatus = mistralService.getStatus();
    
    if (!serviceStatus.initialized) {
      await mistralService.initialize();
    }
    
    // Generate detailed analysis using Mistral
    const prompt = `
      You are a market analysis AI assistant. Provide a detailed analysis of current market conditions.
      Include analysis of:
      - Overall market sentiment and direction
      - Key technical indicators
      - Impact of recent economic events
      - Sector rotation and leadership
      - Potential risks and opportunities
      
      Keep the analysis to 3-4 paragraphs (200-300 words total).
      Focus on being insightful and actionable.
      Do not include disclaimers or statements about being AI.
    `;
    
    const analysis = await mistralService.generateText(prompt);
    
    return res.json({
      analysis: analysis.trim(),
      generatedAt: Date.now()
    });
  } catch (error) {
    return handleError(res, error, 'Failed to generate market analysis');
  }
});

export default router;